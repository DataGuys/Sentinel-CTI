{
  "type": "Microsoft.Portal/dashboards",
  "apiVersion": "2020-09-01-preview",
  "name": "[variables('dashboardName')]",
  "location": "[parameters('location')]",
  "tags": "[union(parameters('tags'), createObject('hidden-title', 'CTI Inoculation Engine Operational Dashboard', 'Component', 'Monitoring', 'Version', 'V5'))]",
  "properties": {
    "lenses": {
      "0": {
        "order": 0,
        "parts": {
          "0": {
            "position": {
              "x": 0,
              "y": 0,
              "colSpan": 18,
              "rowSpan": 1
            },
            "metadata": {
              "inputs": [],
              "type": "Extension/HubsExtension/PartType/MarkdownPart",
              "settings": {
                "content": {
                  "settings": {
                    "content": "# Central Threat Intelligence v5.0 - Operational Dashboard\nThis dashboard provides real-time monitoring of the threat intelligence processing pipeline, distribution status, and system health.",
                    "title": "",
                    "subtitle": "",
                    "markdownSource": 1
                  }
                }
              }
            }
          },
          "1": {
            "position": {
              "x": 0,
              "y": 1,
              "colSpan": 6,
              "rowSpan": 4
            },
            "metadata": {
              "inputs": [
                {
                  "name": "resourceTypeMode",
                  "isOptional": true,
                  "value": "workspace"
                },
                {
                  "name": "ComponentId",
                  "isOptional": true,
                  "value": {
                    "SubscriptionId": "[subscription().subscriptionId]",
                    "ResourceGroup": "[resourceGroup().name]",
                    "Name": "[parameters('ctiWorkspaceName')]",
                    "ResourceId": "[parameters('ctiWorkspaceId')]"
                  }
                },
                {
                  "name": "Query",
                  "isOptional": true,
                  "value": "CTI_TelemetryData_CL | where TimeGenerated > ago(24h) | summarize TotalProcessed=sum(Column1), SuccessCount=sum(Column2), ErrorCount=sum(Column3) by bin(TimeGenerated, 1h) | render timechart"
                },
                {
                  "name": "TimeRange",
                  "isOptional": true,
                  "value": "P1D"
                },
                {
                  "name": "Dimensions",
                  "isOptional": true,
                  "value": {
                    "xAxis": {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    "yAxis": [
                      {
                        "name": "TotalProcessed",
                        "type": "real"
                      },
                      {
                        "name": "SuccessCount",
                        "type": "real"
                      },
                      {
                        "name": "ErrorCount",
                        "type": "real"
                      }
                    ],
                    "splitBy": [],
                    "aggregation": "Sum"
                  }
                },
                {
                  "name": "Version",
                  "isOptional": true,
                  "value": "1.0"
                },
                {
                  "name": "PartId",
                  "isOptional": true,
                  "value": "Indicator Processing Status"
                },
                {
                  "name": "PartTitle",
                  "isOptional": true,
                  "value": "Indicator Processing Metrics"
                }
              ],
              "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
              "settings": {}
            }
          },
          "2": {
            "position": {
              "x": 6,
              "y": 1,
              "colSpan": 6,
              "rowSpan": 4
            },
            "metadata": {
              "inputs": [
                {
                  "name": "resourceTypeMode",
                  "isOptional": true,
                  "value": "workspace"
                },
                {
                  "name": "ComponentId",
                  "isOptional": true,
                  "value": {
                    "SubscriptionId": "[subscription().subscriptionId]",
                    "ResourceGroup": "[resourceGroup().name]",
                    "Name": "[parameters('ctiWorkspaceName')]",
                    "ResourceId": "[parameters('ctiWorkspaceId')]"
                  }
                },
                {
                  "name": "Query",
                  "isOptional": true,
                  "value": "CTI_TelemetryData_CL | where TimeGenerated > ago(24h) | summarize SuccessRate = (sum(Column2) * 100.0 / sum(Column1)) by bin(TimeGenerated, 1h) | render timechart"
                },
                {
                  "name": "TimeRange",
                  "isOptional": true,
                  "value": "P1D"
                },
                {
                  "name": "Version",
                  "isOptional": true,
                  "value": "1.0"
                },
                {
                  "name": "PartId",
                  "isOptional": true,
                  "value": "Success Rate Trend"
                },
                {
                  "name": "PartTitle",
                  "isOptional": true,
                  "value": "Distribution Success Rate (%)"
                }
              ],
              "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
              "settings": {}
            }
          },
          "3": {
            "position": {
              "x": 12,
              "y": 1,
              "colSpan": 6,
              "rowSpan": 4
            },
            "metadata": {
              "inputs": [
                {
                  "name": "resourceTypeMode",
                  "isOptional": true,
                  "value": "workspace"
                },
                {
                  "name": "ComponentId",
                  "isOptional": true,
                  "value": {
                    "SubscriptionId": "[subscription().subscriptionId]",
                    "ResourceGroup": "[resourceGroup().name]",
                    "Name": "[parameters('ctiWorkspaceName')]",
                    "ResourceId": "[parameters('ctiWorkspaceId')]"
                  }
                },
                {
                  "name": "Query",
                  "isOptional": true,
                  "value": "CTI_ProcessingErrors_CL | where TimeGenerated > ago(24h) | summarize Count=count() by ErrorType_s | top 5 by Count desc | render piechart"
                },
                {
                  "name": "TimeRange",
                  "isOptional": true,
                  "value": "P1D"
                },
                {
                  "name": "Version",
                  "isOptional": true,
                  "value": "1.0"
                },
                {
                  "name": "PartId",
                  "isOptional": true,
                  "value": "Top Error Types"
                },
                {
                  "name": "PartTitle",
                  "isOptional": true,
                  "value": "Top Error Types (Last 24h)"
                }
              ],
              "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
              "settings": {}
            }
          },
          "4": {
            "position": {
              "x": 0,
              "y": 5,
              "colSpan": 18,
              "rowSpan": 1
            },
            "metadata": {
              "inputs": [],
              "type": "Extension/HubsExtension/PartType/MarkdownPart",
              "settings": {
                "content": {
                  "settings": {
                    "content": "## System Health",
                    "title": "",
                    "subtitle": "",
                    "markdownSource": 1
                  }
                }
              }
            }
          },
          "5": {
            "position": {
              "x": 0,
              "y": 6,
              "colSpan": 8,
              "rowSpan": 3
            },
            "metadata": {
              "inputs": [
                {
                  "name": "resourceTypeMode",
                  "isOptional": true,
                  "value": "workspace"
                },
                {
                  "name": "ComponentId",
                  "isOptional": true,
                  "value": {
                    "SubscriptionId": "[subscription().subscriptionId]",
                    "ResourceGroup": "[resourceGroup().name]",
                    "Name": "[parameters('ctiWorkspaceName')]",
                    "ResourceId": "[parameters('ctiWorkspaceId')]"
                  }
                },
                {
                  "name": "Query",
                  "isOptional": true,
                  "value": "// System health status\r\n// Logic App run status\r\nlet logicApps = dynamic([\"CTI-TAXII2-Connector\", \"CTI-DefenderXDR-Connector\", \"CTI-MDTI-Connector\", \"CTI-EntraID-Connector\", \"CTI-ExchangeOnline-Connector\", \"CTI-SecurityCopilot-Connector\", \"CTI-Housekeeping\", \"CTI-ThreatFeedSync\"]);\r\n\r\n// Get Logic App runs status\r\nlet workflowRuns = union \r\n    // Get recent workflow runs\r\n    (workspace(\"*\").WorkflowRuntime\r\n    | where TimeGenerated > ago(24h)\r\n    | where ResourceId contains \"Microsoft.Logic/workflows\" and Status in (\"Failed\", \"Succeeded\")\r\n    | extend ResourceName = tostring(split(ResourceId, \"/\")[8])\r\n    | extend isLogicApp = indexof(logicApps, ResourceName) != -1\r\n    | where isLogicApp\r\n    | project TimeGenerated, ResourceName, Status, startTime_t);\r\n\r\n// Process workflow status\r\nworkflowRuns\r\n| summarize LastRunStatus = arg_max(TimeGenerated, Status) by ResourceName\r\n| extend Status = iff(LastRunStatus == \"Failed\", \"Failed\", \"Healthy\")\r\n| project Component = ResourceName, Status\r\n| union (\r\n    // Add a row for workspace status - always healthy if query runs\r\n    datatable(Component:string, Status:string)[ \"Log Analytics Workspace\", \"Healthy\"]\r\n)\r\n| order by Component asc"
                },
                {
                  "name": "TimeRange",
                  "isOptional": true,
                  "value": "P1D"
                },
                {
                  "name": "Version",
                  "isOptional": true,
                  "value": "1.0"
                },
                {
                  "name": "PartId",
                  "isOptional": true,
                  "value": "System Component Health"
                },
                {
                  "name": "PartTitle",
                  "isOptional": true,
                  "value": "System Component Health"
                }
              ],
              "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
              "settings": {}
            }
          },
          "6": {
            "position": {
              "x": 8,
              "y": 6,
              "colSpan": 10,
              "rowSpan": 3
            },
            "metadata": {
              "inputs": [
                {
                  "name": "resourceTypeMode",
                  "isOptional": true,
                  "value": "workspace"
                },
                {
                  "name": "ComponentId",
                  "isOptional": true,
                  "value": {
                    "SubscriptionId": "[subscription().subscriptionId]",
                    "ResourceGroup": "[resourceGroup().name]",
                    "Name": "[parameters('ctiWorkspaceName')]",
                    "ResourceId": "[parameters('ctiWorkspaceId')]"
                  }
                },
                {
                  "name": "Query",
                  "isOptional": true,
                  "value": "// Logic App run history\r\nlet logicApps = dynamic([\"CTI-TAXII2-Connector\", \"CTI-DefenderXDR-Connector\", \"CTI-MDTI-Connector\", \"CTI-EntraID-Connector\", \"CTI-ExchangeOnline-Connector\", \"CTI-SecurityCopilot-Connector\", \"CTI-Housekeeping\", \"CTI-ThreatFeedSync\"]);\r\n\r\n// Get Logic App runs\r\nworkspace(\"*\").WorkflowRuntime\r\n| where TimeGenerated > ago(24h)\r\n| where ResourceId contains \"Microsoft.Logic/workflows\"\r\n| extend ResourceName = tostring(split(ResourceId, \"/\")[8])\r\n| extend isLogicApp = indexof(logicApps, ResourceName) != -1\r\n| where isLogicApp\r\n| project TimeGenerated, Connector = ResourceName, Status, RunId = WorkflowRunId\r\n| order by TimeGenerated desc\r\n| take 10"
                },
                {
                  "name": "TimeRange",
                  "isOptional": true,
                  "value": "P1D"
                },
                {
                  "name": "Version",
                  "isOptional": true,
                  "value": "1.0"
                },
                {
                  "name": "PartId",
                  "isOptional": true,
                  "value": "Recent Connector Runs"
                },
                {
                  "name": "PartTitle",
                  "isOptional": true,
                  "value": "Recent Connector Runs"
                }
              ],
              "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
              "settings": {}
            }
          },
          "7": {
            "position": {
              "x": 0,
              "y": 9,
              "colSpan": 18,
              "rowSpan": 1
            },
            "metadata": {
              "inputs": [],
              "type": "Extension/HubsExtension/PartType/MarkdownPart",
              "settings": {
                "content": {
                  "settings": {
                    "content": "## Distribution Status",
                    "title": "",
                    "subtitle": "",
                    "markdownSource": 1
                  }
                }
              }
            }
          },
          "8": {
            "position": {
              "x": 0,
              "y": 10,
              "colSpan": 9,
              "rowSpan": 4
            },
            "metadata": {
              "inputs": [
                {
                  "name": "resourceTypeMode",
                  "isOptional": true,
                  "value": "workspace"
                },
                {
                  "name": "ComponentId",
                  "isOptional": true,
                  "value": {
                    "SubscriptionId": "[subscription().subscriptionId]",
                    "ResourceGroup": "[resourceGroup().name]",
                    "Name": "[parameters('ctiWorkspaceName')]",
                    "ResourceId": "[parameters('ctiWorkspaceId')]"
                  }
                },
                {
                  "name": "Query",
                  "isOptional": true,
                  "value": "// Distribution of indicators by target product\r\nunion \r\n(CTI_IPIndicators_CL\r\n| where Active_b == true\r\n| extend Type = \"IP\", Value = IPAddress_s, Distribution = split(DistributionTargets_s, \", \")),\r\n(CTI_DomainIndicators_CL\r\n| where Active_b == true\r\n| extend Type = \"Domain\", Value = Domain_s, Distribution = split(DistributionTargets_s, \", \")),\r\n(CTI_URLIndicators_CL\r\n| where Active_b == true\r\n| extend Type = \"URL\", Value = URL_s, Distribution = split(DistributionTargets_s, \", \")),\r\n(CTI_FileHashIndicators_CL\r\n| where Active_b == true\r\n| extend Type = \"File Hash\", Value = coalesce(SHA256_s, SHA1_s, MD5_s), Distribution = split(DistributionTargets_s, \", \"))\r\n| mv-expand Target = Distribution\r\n| summarize Count = count() by tostring(Target), Type\r\n| where isnotempty(Target)\r\n| order by Count desc"
                },
                {
                  "name": "TimeRange",
                  "isOptional": true,
                  "value": "P1D"
                },
                {
                  "name": "Version",
                  "isOptional": true,
                  "value": "1.0"
                },
                {
                  "name": "PartId",
                  "isOptional": true,
                  "value": "Distribution by Target"
                },
                {
                  "name": "PartTitle",
                  "isOptional": true,
                  "value": "Distribution by Target Platform"
                }
              ],
              "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
              "settings": {}
            }
          },
          "9": {
            "position": {
              "x": 9,
              "y": 10,
              "colSpan": 9,
              "rowSpan": 4
            },
            "metadata": {
              "inputs": [
                {
                  "name": "resourceTypeMode",
                  "isOptional": true,
                  "value": "workspace"
                },
                {
                  "name": "ComponentId",
                  "isOptional": true,
                  "value": {
                    "SubscriptionId": "[subscription().subscriptionId]",
                    "ResourceGroup": "[resourceGroup().name]",
                    "Name": "[parameters('ctiWorkspaceName')]",
                    "ResourceId": "[parameters('ctiWorkspaceId')]"
                  }
                },
                {
                  "name": "Query",
                  "isOptional": true,
                  "value": "// Distribution history\r\nCTI_DistributionHistory_CL\r\n| where TimeGenerated > ago(24h)\r\n| summarize SuccessCount = countif(Status_s == \"Success\"), ErrorCount = countif(Status_s == \"Error\"), WaitingCount = countif(Status_s == \"Waiting\") by TargetSystem_s\r\n| extend TotalAttempts = SuccessCount + ErrorCount + WaitingCount\r\n| project TargetSystem_s, SuccessCount, ErrorCount, WaitingCount, TotalAttempts, SuccessRate = iff(TotalAttempts > 0, 100.0 * SuccessCount / TotalAttempts, 0.0)\r\n| order by TotalAttempts desc"
                },
                {
                  "name": "TimeRange",
                  "isOptional": true,
                  "value": "P1D"
                },
                {
                  "name": "Version",
                  "isOptional": true,
                  "value": "1.0"
                },
                {
                  "name": "PartId",
                  "isOptional": true,
                  "value": "Distribution History"
                },
                {
                  "name": "PartTitle",
                  "isOptional": true,
                  "value": "Distribution Success Rate by Target (24h)"
                }
              ],
              "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
              "settings": {}
            }
          },
          "10": {
            "position": {
              "x": 0,
              "y": 14,
              "colSpan": 18,
              "rowSpan": 1
            },
            "metadata": {
              "inputs": [],
              "type": "Extension/HubsExtension/PartType/MarkdownPart",
              "settings": {
                "content": {
                  "settings": {
                    "content": "## Approval Workflow Status",
                    "title": "",
                    "subtitle": "",
                    "markdownSource": 1
                  }
                }
              }
            }
          },
          "11": {
            "position": {
              "x": 0,
              "y": 15,
              "colSpan": 6,
              "rowSpan": 4
            },
            "metadata": {
              "inputs": [
                {
                  "name": "resourceTypeMode",
                  "isOptional": true,
                  "value": "workspace"
                },
                {
                  "name": "ComponentId",
                  "isOptional": true,
                  "value": {
                    "SubscriptionId": "[subscription().subscriptionId]",
                    "ResourceGroup": "[resourceGroup().name]",
                    "Name": "[parameters('ctiWorkspaceName')]",
                    "ResourceId": "[parameters('ctiWorkspaceId')]"
                  }
                },
                {
                  "name": "Query",
                  "isOptional": true,
                  "value": "// Approval workflow stats\r\nCTI_DistributionHistory_CL\r\n| where TimeGenerated > ago(7d) and DistributionType_s has \"Approval\"\r\n| extend ApprovalType = iff(DistributionType_s has \"Critical\", \"Critical\", \"Standard\")\r\n| summarize count() by Status_s, ApprovalType\r\n| extend Status = case(\r\n    Status_s == \"Waiting\", \"Pending\",\r\n    Status_s == \"Success\" and ApprovalType == \"Critical\", \"Approved (Critical)\",\r\n    Status_s == \"Success\" and ApprovalType == \"Standard\", \"Approved (Standard)\",\r\n    Status_s == \"Error\", \"Error\",\r\n    \"Other\"\r\n)\r\n| project Status, Count=count_\r\n| order by Count desc"
                },
                {
                  "name": "TimeRange",
                  "isOptional": true,
                  "value": "P7D"
                },
                {
                  "name": "Version",
                  "isOptional": true,
                  "value": "1.0"
                },
                {
                  "name": "PartId",
                  "isOptional": true,
                  "value": "Approval Stats"
                },
                {
                  "name": "PartTitle",
                  "isOptional": true,
                  "value": "Approval Workflow Status (7d)"
                }
              ],
              "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
              "settings": {}
            }
          },
          "12": {
            "position": {
              "x": 6,
              "y": 15,
              "colSpan": 12,
              "rowSpan": 4
            },
            "metadata": {
              "inputs": [
                {
                  "name": "resourceTypeMode",
                  "isOptional": true,
                  "value": "workspace"
                },
                {
                  "name": "ComponentId",
                  "isOptional": true,
                  "value": {
                    "SubscriptionId": "[subscription().subscriptionId]",
                    "ResourceGroup": "[resourceGroup().name]",
                    "Name": "[parameters('ctiWorkspaceName')]",
                    "ResourceId": "[parameters('ctiWorkspaceId')]"
                  }
                },
                {
                  "name": "Query",
                  "isOptional": true,
                  "value": "// Pending approvals\r\nCTI_DistributionHistory_CL\r\n| where TimeGenerated > ago(7d)\r\n| where DistributionType_s has \"Approval\" and Status_s == \"Waiting\"\r\n| extend ApprovalType = iff(DistributionType_s has \"Critical\", \"Critical\", \"Standard\")\r\n| project TimeGenerated, IndicatorId_g, IndicatorValue_s, IndicatorType_s, ApprovalType, Details_s\r\n| order by TimeGenerated asc"
                },
                {
                  "name": "TimeRange",
                  "isOptional": true,
                  "value": "P7D"
                },
                {
                  "name": "Version",
                  "isOptional": true,
                  "value": "1.0"
                },
                {
                  "name": "PartId",
                  "isOptional": true,
                  "value": "Pending Approvals"
                },
                {
                  "name": "PartTitle",
                  "isOptional": true,
                  "value": "Pending Approval Requests"
                }
              ],
              "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
              "settings": {}
            }
          }
        }
      }
    },
    "metadata": {
      "model": {
        "timeRange": {
          "value": {
            "relative": {
              "duration": 24,
              "timeUnit": 1
            }
          },
          "type": "MsPortalFx.Composition.Configuration.ValueTypes.TimeRange"
        }
      }
    }
  }
}
