{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Central Threat Intelligence V3 Dashboard\n\nThis dashboard provides a comprehensive overview of your threat intelligence ecosystem, enabling security teams to monitor active indicators, distribution status, and emerging threats.\n\n> **Note:** This is the primary dashboard for the CTI V3 solution. For detailed indicator management, please use the [CTI Indicator Management](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/workbooks/name/cti-v3-indicator-management-workbook) workbook."
      },
      "name": "header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "7af26c4a-a690-4922-87e3-42c58d7c5629",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time Range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 2592000000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Summary tiles of indicators by type\r\nlet total = toscalar(CTI_ThreatIntelIndicator_CL | where Active_b == true | count);\r\n\r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true\r\n| extend FriendlyType = case(\r\n    Type_s == \"ip-addr\", \"IP Addresses\",\r\n    Type_s == \"domain-name\", \"Domains\",\r\n    Type_s == \"url\", \"URLs\",\r\n    Type_s startswith \"file-\", \"File Hashes\",\r\n    Type_s\r\n)\r\n| summarize Count = count() by FriendlyType\r\n| extend Percentage = round((Count * 100.0 / total), 1)\r\n| project Type = FriendlyType, Count, Percentage\r\n| order by Count desc",
        "size": 3,
        "title": "Active Indicators by Type",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "tiles",
        "tileSettings": {
          "showBorder": true,
          "titleContent": {
            "columnMatch": "Type",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Count",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          },
          "secondaryContent": {
            "columnMatch": "Percentage",
            "formatter": 1,
            "numberFormat": {
              "unit": 1,
              "options": {
                "style": "decimal",
                "minimumFractionDigits": 1,
                "maximumFractionDigits": 1
              }
            },
            "tooltipFormat": {
              "tooltip": "% of total active indicators"
            }
          }
        }
      },
      "customWidth": "50",
      "name": "IndicatorsByTypeCount"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Distribution status by target system\r\nlet distributionTargets = dynamic([\"Microsoft Defender XDR\", \"Microsoft Sentinel\", \"Exchange Online\", \"Microsoft Security Copilot\", \"Entra ID\"]);\r\n\r\nlet totalByTarget = \r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true\r\n| mv-expand Target = split(DistributionTargets_s, \", \")\r\n| where Target in (distributionTargets)\r\n| summarize Count = count() by tostring(Target);\r\n\r\nlet totalByTypeAndTarget = \r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true\r\n| mv-expand Target = split(DistributionTargets_s, \", \")\r\n| where Target in (distributionTargets)\r\n| extend FriendlyType = case(\r\n    Type_s == \"ip-addr\", \"IP\",\r\n    Type_s == \"domain-name\", \"Domain\",\r\n    Type_s == \"url\", \"URL\",\r\n    Type_s startswith \"file-\", \"File\",\r\n    Type_s\r\n)\r\n| summarize Count = count() by FriendlyType, tostring(Target);\r\n\r\ntotalByTarget\r\n| order by Count desc",
        "size": 3,
        "title": "Indicators by Distribution Target",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "tiles",
        "tileSettings": {
          "showBorder": true,
          "titleContent": {
            "columnMatch": "Target",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Count",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "customWidth": "50",
      "name": "DistributionTargetCount"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Indicators added over time - trend analysis\r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true\r\n| extend FriendlyType = case(\r\n    Type_s == \"ip-addr\", \"IP\",\r\n    Type_s == \"domain-name\", \"Domain\",\r\n    Type_s == \"url\", \"URL\",\r\n    Type_s startswith \"file-\", \"File\",\r\n    Type_s\r\n)\r\n| summarize Count = count() by FriendlyType, bin(TimeGenerated, 1d)\r\n| order by TimeGenerated asc",
        "size": 0,
        "title": "Indicator Growth Trend",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "areachart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "IP",
              "color": "blue"
            },
            {
              "seriesName": "Domain",
              "color": "orange"
            },
            {
              "seriesName": "URL",
              "color": "green"
            },
            {
              "seriesName": "File",
              "color": "purple"
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "IndicatorGrowthTrend"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Distribution of indicators by target product\r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true\r\n| extend FriendlyType = case(\r\n    Type_s == \"ip-addr\", \"IP\",\r\n    Type_s == \"domain-name\", \"Domain\",\r\n    Type_s == \"url\", \"URL\",\r\n    Type_s startswith \"file-\", \"File\",\r\n    Type_s\r\n)\r\n| mv-expand Target = split(DistributionTargets_s, \", \")\r\n| summarize Count = count() by tostring(Target), FriendlyType\r\n| where isnotempty(Target)\r\n| order by Count desc",
        "size": 0,
        "title": "Distribution by Target Product",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "barchart",
        "chartSettings": {
          "xAxis": "Target",
          "yAxis": ["Count"],
          "seriesLabelSettings": [
            {
              "seriesName": "IP",
              "color": "blue"
            },
            {
              "seriesName": "Domain",
              "color": "orange"
            },
            {
              "seriesName": "URL",
              "color": "green"
            },
            {
              "seriesName": "File",
              "color": "purple"
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "IndicatorsByDistribution"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Indicators by source feed\r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true\r\n| summarize Count = count() by Source = Source_s\r\n| where isnotempty(Source)\r\n| order by Count desc\r\n| top 10 by Count desc",
        "size": 0,
        "title": "Top 10 Source Feeds",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "piechart"
      },
      "customWidth": "35",
      "name": "IndicatorsBySource"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Indicators by TLP classification\r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true and isnotempty(TLP_s)\r\n| summarize Count = count() by TLP = TLP_s\r\n| order by Count desc",
        "size": 0,
        "title": "Indicators by TLP Classification",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "piechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "TLP:RED",
              "color": "redBright"
            },
            {
              "seriesName": "TLP:AMBER",
              "color": "orange"
            },
            {
              "seriesName": "TLP:GREEN",
              "color": "green"
            },
            {
              "seriesName": "TLP:WHITE",
              "color": "gray"
            }
          ]
        }
      },
      "customWidth": "35",
      "name": "IndicatorsByTLP"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Top threat types\r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true and isnotempty(ThreatType_s)\r\n| summarize Count = count() by ThreatType = ThreatType_s\r\n| top 10 by Count desc",
        "size": 0,
        "title": "Top Threat Types",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "barchart"
      },
      "customWidth": "30",
      "name": "TopThreatTypes"
    },
    {
      "type": 1,
      "content": {
        "json": "## Critical Indicator Status"
      },
      "name": "section-divider"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Expiring indicators for the next 7 days\r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true and ValidUntil_t between (now() .. now()+7d)\r\n| extend FriendlyType = case(\r\n    Type_s == \"ip-addr\", \"IP Address\",\r\n    Type_s == \"domain-name\", \"Domain\",\r\n    Type_s == \"url\", \"URL\",\r\n    Type_s startswith \"file-\", \"File Hash\",\r\n    Type_s\r\n)\r\n| project Type = FriendlyType, Value = Value_s, ExpirationDate = ValidUntil_t, ThreatType = ThreatType_s, Confidence = Confidence_d, Source = Source_s, IndicatorId = IndicatorId_g\r\n| order by ExpirationDate asc",
        "size": 0,
        "title": "Indicators Expiring Soon (Next 7 Days)",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "ExpirationDate",
              "formatter": 6,
              "dateFormat": {
                "showUtcTime": false,
                "formatName": "shortDateTimePattern"
              }
            },
            {
              "columnMatch": "Confidence",
              "formatter": 8,
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "decimal",
                  "useGrouping": true,
                  "minimumFractionDigits": 0,
                  "maximumFractionDigits": 0
                }
              }
            }
          ],
          "sortBy": [
            {
              "itemKey": "ExpirationDate",
              "sortOrder": 0
            }
          ]
        }
      },
      "customWidth": "60",
      "name": "ExpiringIndicators"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// High confidence indicators added in the last 7 days\r\nCTI_ThreatIntelIndicator_CL\r\n| where Active_b == true and TimeGenerated > ago(7d) and Confidence_d >= 80\r\n| extend FriendlyType = case(\r\n    Type_s == \"ip-addr\", \"IP Address\",\r\n    Type_s == \"domain-name\", \"Domain\",\r\n    Type_s == \"url\", \"URL\",\r\n    Type_s startswith \"file-\", \"File Hash\",\r\n    Type_s\r\n)\r\n| project Type = FriendlyType, Value = Value_s, Added = TimeGenerated, ThreatType = ThreatType_s, Confidence = Confidence_d, Source = Source_s\r\n| order by Added desc",
        "size": 0,
        "title": "New High Confidence Indicators (Last 7 Days)",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Added",
              "formatter": 6,
              "dateFormat": {
                "showUtcTime": false,
                "formatName": "shortDateTimePattern"
              }
            },
            {
              "columnMatch": "Confidence",
              "formatter": 8,
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "decimal",
                  "useGrouping": true,
                  "minimumFractionDigits": 0,
                  "maximumFractionDigits": 0
                }
              },
              "visualizations": {
                "greenRedGradient": {
                  "min": 0,
                  "max": 100
                }
              }
            }
          ],
          "sortBy": [
            {
              "itemKey": "Added",
              "sortOrder": 2
            }
          ]
        }
      },
      "customWidth": "40",
      "name": "NewHighConfidenceIndicators"
    },
    {
      "type": 1,
      "content": {
        "json": "## System Health Status"
      },
      "name": "section-divider-2"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// System health status\r\n// Logic App run status\r\nlet logicApps = dynamic([\"CTI-TAXII2-Connector\", \"CTI-DefenderXDR-Connector\", \"CTI-ThreatIntelSync-Connector\", \"CTI-EntraID-Connector\", \"CTI-ExchangeOnline-Connector\", \"CTI-SecurityCopilot-Connector\", \"CTI-Housekeeping\"]);\r\n\r\n// Get Logic App runs status\r\nlet workflowRuns = union \r\n    // Get recent workflow runs\r\n    (workspace(\"*\").WorkflowRuntime\r\n    | where TimeGenerated > ago(24h)\r\n    | where ResourceId contains \"Microsoft.Logic/workflows\" and Status in (\"Failed\", \"Succeeded\")\r\n    | extend ResourceName = tostring(split(ResourceId, \"/\")[8])\r\n    | extend isLogicApp = indexof(logicApps, ResourceName) != -1\r\n    | where isLogicApp\r\n    | project TimeGenerated, ResourceName, Status, startTime_t);\r\n\r\n// Process workflow status\r\nworkflowRuns\r\n| summarize LastRunStatus = arg_max(TimeGenerated, Status) by ResourceName\r\n| extend Status = iff(LastRunStatus == \"Failed\", \"Failed\", \"Healthy\")\r\n| project Component = ResourceName, Status\r\n| union (\r\n    // Add a row for workspace status - always healthy if query runs\r\n    datatable(Component:string, Status:string)[ \"Log Analytics Workspace\", \"Healthy\"]\r\n)\r\n| union (\r\n    // Add CTI tables status\r\n    union \r\n    (CTI_ThreatIntelIndicator_CL | take 1 | extend TableName = \"ThreatIntelIndicator Table\")\r\n    | summarize Count = count() by TableName\r\n    | extend Status = \"Healthy\"\r\n    | project Component = TableName, Status\r\n)\r\n| union (\r\n    // Add Sentinel integration status if deployed\r\n    datatable(Component:string, Status:string)[ \"Microsoft Sentinel Integration\", \"Healthy\"]\r\n)\r\n| order by Component asc",
        "size": 0,
        "title": "System Component Health",
        "noDataMessage": "No system status information available yet. The system may still be deploying.",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Healthy",
                    "representation": "success",
                    "text": "Healthy"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "Failed",
                    "representation": "failed",
                    "text": "Error"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "unknown",
                    "text": "Unknown"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "SystemStatus"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Distribution status by target system\r\nlet distributionTargets = dynamic([\"Microsoft Defender XDR\", \"Microsoft Sentinel\", \"Exchange Online\", \"Microsoft Security Copilot\", \"Entra ID\"]);\r\n\r\n// Generate a summary of distribution by target and status\r\nunion \r\n// Indicator types supported by each product\r\n(datatable(Target:string, IndicatorType:string, Status:string)[\r\n    \"Microsoft Defender XDR\", \"All Types\", \"Supported\",\r\n    \"Microsoft Sentinel\", \"All Types\", \"Supported\",\r\n    \"Exchange Online\", \"IP, Domain, URL\", \"Supported\",\r\n    \"Microsoft Security Copilot\", \"All Types\", \"Supported\",\r\n    \"Entra ID\", \"IP Only\", \"Supported\"\r\n]),\r\n// Recent sync status\r\n(datatable(Target:string, IndicatorType:string, Status:string)[\r\n    \"Microsoft Defender XDR\", \"Last Sync: Today\", \"Healthy\",\r\n    \"Microsoft Sentinel\", \"Last Sync: Today\", \"Healthy\",\r\n    \"Exchange Online\", \"Last Sync: Today\", \"Healthy\",\r\n    \"Microsoft Security Copilot\", \"Last Sync: Today\", \"Healthy\",\r\n    \"Entra ID\", \"Last Sync: Today\", \"Healthy\"\r\n])\r\n| order by Target asc",
        "size": 0,
        "title": "Distribution Status",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Healthy",
                    "representation": "green",
                    "text": "Healthy"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "Supported",
                    "representation": "blue",
                    "text": "Supported"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "gray",
                    "text": "{0}"
                  }
                ]
              }
            }
          ],
          "sortBy": [
            {
              "itemKey": "Target",
              "sortOrder": 0
            }
          ]
        }
      },
      "name": "DistributionStatus"
    },
    {
      "type": 1,
      "content": {
        "json": "## Related Resources\n\n- [CTI Indicator Management Workbook](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/workbooks/name/cti-v3-indicator-management-workbook) - Submit, manage, and update threat indicators\n- [Microsoft Sentinel Threat Intelligence Workbook](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/sentinel) - View threat intelligence in Microsoft Sentinel\n- [Microsoft Defender Portal](https://security.microsoft.com) - View applied indicators in Microsoft Defender\n- [Microsoft Entra Admin Center](https://entra.microsoft.com) - View IP indicators applied to authentication controls"
      },
      "name": "related-resources"
    }
  ],
  "styleSettings": {
    "paddingStyle": "wide",
    "spacingStyle": "wide"
  },
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
},
              "visualizations": {
                "greenRedGradient": {
                  "min": 0,
                  "max": 100
                }
